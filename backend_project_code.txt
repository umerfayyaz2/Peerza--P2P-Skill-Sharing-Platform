========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\manage.py
========================================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'peerza_backend.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\peerza_backend\asgi.py
========================================
"""
ASGI config for peerza_backend project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'peerza_backend.settings')

application = get_asgi_application()



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\peerza_backend\settings.py
========================================
"""
Django settings for peerza_backend project.

Generated by 'django-admin startproject' using Django 5.2.8.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-dh^!%eth&cg%qdwwv7+&a4swg#$4k&&snpli&1os@ua860xabw'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # --- 3rd Party Apps (We just installed these) ---
    'rest_framework',
    'corsheaders',

    # --- Local Apps (Our custom code) ---
    'users', 
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware', # <--- ADD THIS AT THE TOP
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'peerza_backend.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'peerza_backend.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
CORS_ALLOW_ALL_ORIGINS = True # For development only, we allow all connections.
AUTH_USER_MODEL = 'users.User'

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    )
}

# Media Configuration
import os

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Email Backend (Prints emails to the terminal console instead of sending them)
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\peerza_backend\urls.py
========================================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    # This points to the file you showed me earlier
    path('api/', include('users.urls')), 
]

# Serve media files (Profile Pictures) in development
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\peerza_backend\wsgi.py
========================================
"""
WSGI config for peerza_backend project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'peerza_backend.settings')

application = get_wsgi_application()



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\peerza_backend\__init__.py
========================================



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\admin.py
========================================
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User, Skill, UserSkill, Meeting, Notification, Message, FriendRequest, Friendship , Availability


# 1. Register the Custom User
admin.site.register(User, UserAdmin)

# 2. Register other core models
admin.site.register(Skill)
admin.site.register(UserSkill)
admin.site.register(Meeting)
admin.site.register(Message)


# 3. ✅ Register Notifications with custom admin view
@admin.register(Notification)
class NotificationAdmin(admin.ModelAdmin):
    list_display = ("id", "user", "actor", "type", "is_read", "created_at")
    list_filter = ("type", "is_read")
    search_fields = ("user__username", "actor__username")


# 4. ✅ Register Friend Request & Friendship models
admin.site.register(FriendRequest)
admin.site.register(Friendship)

@admin.register(Availability)
class AvailabilityAdmin(admin.ModelAdmin):
    list_display = ('user', 'day_of_week', 'start_time', 'end_time')
    list_filter = ('day_of_week',)



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\apps.py
========================================
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\models.py
========================================
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.utils import timezone

# 1. USER MODEL
class User(AbstractUser):
    email = models.EmailField(unique=True, null=True, blank=True)
    bio = models.TextField(blank=True, null=True)
    avatar = models.ImageField(upload_to='avatars/', blank=True, null=True)
    is_pro = models.BooleanField(default=False)
    last_active = models.DateTimeField(default=timezone.now)

    # REQUIRED for 1-on-1 chat + presence
    firebase_uid = models.CharField(max_length=200, blank=True, null=True, unique=True)

    def is_online(self):
        return (timezone.now() - self.last_active).total_seconds() < 300

    def __str__(self):
        return self.username


# 2. SKILL
class Skill(models.Model):
    name = models.CharField(max_length=100, unique=True)

    def __str__(self):
        return self.name


# 3. USER-SKILL
class UserSkill(models.Model):
    SKILL_TYPES = (
        ('TEACH', 'Can Teach'),
        ('LEARN', 'Wants to Learn'),
    )

    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='user_skills')
    skill = models.ForeignKey(Skill, on_delete=models.CASCADE)
    proficiency = models.CharField(max_length=50, default="Beginner")
    skill_type = models.CharField(max_length=10, choices=SKILL_TYPES)

    def __str__(self):
        return f"{self.user.username} - {self.skill.name} ({self.skill_type})"


# 4. CALL MODEL
class Call(models.Model):
    caller = models.ForeignKey(User, related_name='calls_made', on_delete=models.CASCADE)
    receiver = models.ForeignKey(User, related_name='calls_received', on_delete=models.CASCADE)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.caller.username} calling {self.receiver.username}"


# 5. MESSAGE MODEL
class Message(models.Model):
    sender = models.ForeignKey(User, related_name='sent_messages', on_delete=models.CASCADE)
    receiver = models.ForeignKey(User, related_name='received_messages', on_delete=models.CASCADE)
    content = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)
    is_read = models.BooleanField(default=False)

    class Meta:
        ordering = ['timestamp']

    def __str__(self):
        return f"Msg from {self.sender.username} to {self.receiver.username}"

# 6. AVAILABILITY (per-user weekly slots)
class Availability(models.Model):
    DAY_CHOICES = [
        ('MONDAY', 'Monday'),
        ('TUESDAY', 'Tuesday'),
        ('WEDNESDAY', 'Wednesday'),
        ('THURSDAY', 'Thursday'),
        ('FRIDAY', 'Friday'),
        ('SATURDAY', 'Saturday'),
        ('SUNDAY', 'Sunday'),
    ]

    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="availability_slots")
    day_of_week = models.CharField(max_length=9, choices=DAY_CHOICES)
    start_time = models.TimeField()
    end_time = models.TimeField()

    def __str__(self):
        return f"{self.user.username} — {self.day_of_week} {self.start_time}–{self.end_time}"


# 6. MEETING MODEL (Scheduler)
class Meeting(models.Model):
    STATUS_CHOICES = [
        ('PENDING', 'Pending'),
        ('ACCEPTED', 'Accepted'),
        ('DECLINED', 'Declined'),
        ('CANCELLED', 'Cancelled'),
    ]

    host = models.ForeignKey(User, related_name='hosted_meetings', on_delete=models.CASCADE)
    guest = models.ForeignKey(User, related_name='invited_meetings', on_delete=models.CASCADE)
    availability = models.ForeignKey('Availability', null=True, blank=True, on_delete=models.SET_NULL)

    topic = models.CharField(max_length=255, blank=True)
    start_datetime = models.DateTimeField()
    end_datetime = models.DateTimeField(null=True, blank=True)
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='PENDING')
    jitsi_room = models.CharField(max_length=255, blank=True, null=True)
    created_at = models.DateTimeField(default=timezone.now)

    def __str__(self):
        return f"Meeting: {self.topic} ({self.status})"


# 7. NOTIFICATION MODEL
class Notification(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='notifications')
    actor = models.ForeignKey(User, null=True, blank=True, on_delete=models.SET_NULL)
    type = models.CharField(max_length=50)
    data = models.JSONField(default=dict)
    is_read = models.BooleanField(default=False)
    created_at = models.DateTimeField(default=timezone.now)

    def __str__(self):
        return f"Notification to {self.user.username} ({self.type})"


# 8. FRIEND REQUEST MODEL ✅
class FriendRequest(models.Model):
    PENDING = "PENDING"
    ACCEPTED = "ACCEPTED"
    DECLINED = "DECLINED"

    STATUS_CHOICES = [
        (PENDING, "Pending"),
        (ACCEPTED, "Accepted"),
        (DECLINED, "Declined"),
    ]

    from_user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="friend_requests_sent")
    to_user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="friend_requests_received")
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default=PENDING)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ("from_user", "to_user")

    def __str__(self):
        return f"Friend request from {self.from_user} to {self.to_user} ({self.status})"


# 9. FRIENDSHIP MODEL ✅
class Friendship(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="friends")
    friend = models.ForeignKey(User, on_delete=models.CASCADE, related_name="friend_of")
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ("user", "friend")

    def __str__(self):
        return f"{self.user.username} ↔ {self.friend.username}"



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\serializers.py
========================================
from rest_framework import serializers
from .models import User, Skill, UserSkill, Meeting, Notification, Message, FriendRequest, Friendship


# 1. Skill Serializer
class SkillSerializer(serializers.ModelSerializer):
    class Meta:
        model = Skill
        fields = ['id', 'name']


# 2. User Serializer
class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['id', 'username', 'bio', 'is_pro', 'avatar']


# 3. UserSkill Serializer
class UserSkillSerializer(serializers.ModelSerializer):
    skill = SkillSerializer(read_only=True)
    user = UserSerializer(read_only=True)

    class Meta:
        model = UserSkill
        fields = ['id', 'user', 'skill', 'proficiency', 'skill_type']


# 4. Registration Serializer
class RegisterSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True)

    class Meta:
        model = User
        fields = ['username', 'password', 'email']  # email is optional

    def create(self, validated_data):
        username = validated_data['username']
        raw_email = validated_data.get('email')
        email = raw_email or None  # turn "" into None

        user = User.objects.create_user(
            username=username,
            email=email,
            password=validated_data['password']
        )
        return user


# 5. Meeting Serializer
class MeetingSerializer(serializers.ModelSerializer):
    host = UserSerializer(read_only=True)
    guest = serializers.PrimaryKeyRelatedField(queryset=User.objects.all())

    class Meta:
        model = Meeting
        fields = [
            'id',
            'host',
            'guest',
            'topic',
            'start_datetime',
            'end_datetime',
            'status',
            'jitsi_room',
            'created_at'
        ]


# 6. ✅ Updated Notification Serializer
class NotificationSerializer(serializers.ModelSerializer):
    actor = UserSerializer(read_only=True)

    class Meta:
        model = Notification
        fields = ("id", "type", "actor", "data", "is_read", "created_at")


# 7. Message Serializer
class MessageSerializer(serializers.ModelSerializer):
    sender = UserSerializer(read_only=True)
    receiver = UserSerializer(read_only=True)

    class Meta:
        model = Message
        fields = ["id", "sender", "receiver", "content", "timestamp", "is_read"]


# 8. Friend Request Serializer
class FriendRequestSerializer(serializers.ModelSerializer):
    from_user = UserSerializer(read_only=True)
    to_user = UserSerializer(read_only=True)

    class Meta:
        model = FriendRequest
        fields = ["id", "from_user", "to_user", "status", "created_at"]


# 9. Friendship Serializer
class FriendshipSerializer(serializers.ModelSerializer):
    friend = UserSerializer(read_only=True)

    class Meta:
        model = Friendship
        fields = ["id", "friend", "created_at"]

from rest_framework import serializers
from .models import Availability

class AvailabilitySerializer(serializers.ModelSerializer):
    class Meta:
        model = Availability
        fields = ['id', 'day_of_week', 'start_time', 'end_time']




========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\tests.py
========================================
from django.test import TestCase

# Create your tests here.



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\urls.py
========================================
from django.urls import path
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView
from rest_framework.routers import DefaultRouter
from . import views
from .views_meeting import MeetingViewSet

router = DefaultRouter()
router.register(r'meetings', MeetingViewSet, basename='meeting')

urlpatterns = [
    # AUTH
    path('register/', views.register_user, name='register'),
    path('login/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),

    # PROFILE
    path('profile/', views.get_my_profile, name='profile'),
    path('change-password/', views.change_password, name='change_password'),

    # FIREBASE
    path('firebase/register-uid/', views.register_firebase_uid, name='register_firebase_uid'),

    # SKILLS
    path('my-skills/', views.my_skills, name='my_skills'),
    path('delete-skill/<int:skill_id>/', views.delete_skill, name='delete_skill'),

    # SEARCH / PROFILE
    path('search/', views.search_peers, name='search_peers'),
    path('users/<int:pk>/', views.get_public_profile, name='public_profile'),

    # CALLS & MEETINGS
    path('call/check/', views.check_calls, name='check_calls'),
    path('call/start/<int:receiver_id>/', views.call_start, name='call_start'),
    path('call/end/<int:receiver_id>/', views.call_end, name='call_end'),
    path('meetings/request/', views.request_meeting, name='request_meeting'),
    path('meetings/<int:meeting_id>/respond/', views.respond_meeting, name='respond_meeting'),
    path('meetings/my/', views.my_meetings, name='my_meetings'),
    path('meetings/pending/', views.pending_meetings, name='pending_meetings'),

    # NOTIFICATIONS
    path('notifications/', views.notifications_list, name='notifications_list'),
    path('notifications/mark-read/<int:notification_id>/', views.mark_notification_read, name='mark_notification_read'),
    path('notifications/mark-read-all/', views.mark_notifications_read_all, name='mark_notifications_read_all'),

    # CHAT
    path('chats/', views.chat_conversations, name='chat_conversations'),
    path('chats/<int:user_id>/messages/', views.chat_messages, name='chat_messages'),
    path('chats/<int:user_id>/send/', views.chat_send, name='chat_send'),
    path('chats/<int:user_id>/read/', views.chat_mark_read, name='chat_mark_read'),

    # FRIENDS
    path('friends/', views.friends_list, name='friends_list'),
    path('friends/requests/', views.friend_requests_inbox, name='friend_requests_inbox'),
    path('friends/request/<int:user_id>/', views.friend_request_send, name='friend_request_send'),
    path('friends/request/respond/<int:request_id>/', views.friend_request_respond, name='friend_request_respond'),

    # AVAILABILITY
    path('availability/<int:user_id>/', views.get_user_availability, name='get_user_availability'),
    path('availability/', views.create_or_update_availability, name='create_or_update_availability'),
]

urlpatterns += router.urls
    



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\views.py
========================================
from django.db import IntegrityError
from django.db.models import Q
from django.shortcuts import get_object_or_404
from django.utils import timezone

from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.response import Response

from .models import (
    User,
    UserSkill,
    Skill,
    Call,
    Meeting,
    Notification,
    Message,
    FriendRequest,
    Friendship,
)

from .serializers import (
    RegisterSerializer,
    UserSerializer,
    UserSkillSerializer,
    SkillSerializer,
    MeetingSerializer,
    NotificationSerializer,
    MessageSerializer,
    FriendRequestSerializer,
)

# =============================================================
# AUTHENTICATION
# =============================================================

@api_view(['POST'])
@permission_classes([AllowAny])
def register_user(request):
    serializer = RegisterSerializer(data=request.data)
    if serializer.is_valid():
        try:
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        except IntegrityError:
            return Response({"detail": "Email already in use"}, status=400)
    return Response(serializer.errors, status=400)

# =============================================================
# PROFILE MANAGEMENT
# =============================================================

@api_view(['GET', 'PATCH'])
@permission_classes([IsAuthenticated])
def get_my_profile(request):
    if request.method == 'GET':
        return Response(UserSerializer(request.user).data)

    # PATCH
    user = request.user
    if request.data.get('remove_avatar') == 'true':
        user.avatar.delete(save=False)
        user.avatar = None
        user.save()

    serializer = UserSerializer(user, data=request.data, partial=True)
    if serializer.is_valid():
        serializer.save()
        return Response(serializer.data)
    return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

# =============================================================
# SKILLS
# =============================================================

@api_view(['GET', 'POST'])
@permission_classes([IsAuthenticated])
def my_skills(request):
    if request.method == 'GET':
        qs = UserSkill.objects.filter(user=request.user)
        return Response(UserSkillSerializer(qs, many=True).data)

    # POST
    if not request.user.is_pro:
        current = UserSkill.objects.filter(user=request.user).count()
        if current >= 2:
            return Response(
                {"error": "Free Plan Limit Reached. Upgrade to Pro to add more skills."},
                status=status.HTTP_403_FORBIDDEN,
            )

    skill_name = request.data.get('skill_name')
    skill_type = request.data.get('skill_type')
    skill_obj, _ = Skill.objects.get_or_create(name=skill_name)
    UserSkill.objects.create(user=request.user, skill=skill_obj, skill_type=skill_type)
    return Response({"message": "Skill added!"}, status=status.HTTP_201_CREATED)


@api_view(['DELETE'])
@permission_classes([IsAuthenticated])
def delete_skill(request, skill_id):
    try:
        us = UserSkill.objects.get(id=skill_id, user=request.user)
    except UserSkill.DoesNotExist:
        return Response({"error": "Skill not found"}, status=404)
    us.delete()
    return Response(status=204)

# =============================================================
# SEARCH
# =============================================================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def search_peers(request):
    query = request.query_params.get('skill', '').strip()
    if not query:
        return Response({"message": "Please provide a skill to search for."}, status=400)

    matches = UserSkill.objects.filter(
        skill__name__icontains=query, skill_type='TEACH'
    ).exclude(user=request.user)

    return Response(UserSkillSerializer(matches, many=True).data)

# =============================================================
# PUBLIC PROFILE
# =============================================================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_public_profile(request, pk):
    try:
        user = User.objects.get(id=pk)
    except User.DoesNotExist:
        return Response({"error": "User not found"}, status=404)

    skills = UserSkill.objects.filter(user=user)
    return Response({
        "user": UserSerializer(user).data,
        "skills": UserSkillSerializer(skills, many=True).data,
    })

# =============================================================
# PASSWORD
# =============================================================

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def change_password(request):
    user = request.user
    old_pw = request.data.get('old_password')
    new_pw = request.data.get('new_password')
    if not user.check_password(old_pw):
        return Response({"error": "Wrong old password."}, status=400)
    user.set_password(new_pw)
    user.save()
    return Response({"message": "Password updated successfully."})

# =============================================================
# CALL SIGNALING (LEGACY)
# =============================================================

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def start_call(request, receiver_id):
    try:
        receiver = User.objects.get(id=receiver_id)
    except User.DoesNotExist:
        return Response({"error": "User not found"}, status=404)

    Call.objects.update_or_create(
        caller=request.user, receiver=receiver, defaults={'is_active': True}
    )
    return Response({"message": "Call started"})

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def check_calls(request):
    active_call = Call.objects.filter(receiver=request.user, is_active=True).last()
    if active_call:
        return Response({"active": True, "caller": UserSerializer(active_call.caller).data})
    return Response({"active": False})

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def end_call(request, receiver_id):
    Call.objects.filter(
        Q(caller=request.user) | Q(receiver=request.user),
        is_active=True,
    ).update(is_active=False)
    return Response({"message": "Call ended"})

# =============================================================
# FIREBASE UID
# =============================================================

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def register_firebase_uid(request):
    uid = request.data.get('firebase_uid')
    if not uid:
        return Response({"detail": "firebase_uid required"}, status=400)

    User.objects.filter(firebase_uid=uid).exclude(id=request.user.id).update(firebase_uid=None)
    request.user.firebase_uid = uid
    request.user.save()
    return Response({"detail": "registered"})

# =============================================================
# MEETINGS
# =============================================================

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def request_meeting(request):
    guest_id = request.data.get("guest_id")
    topic = request.data.get("topic", "")
    start = request.data.get("start_datetime")
    end = request.data.get("end_datetime")

    try:
        guest = User.objects.get(id=guest_id)
    except User.DoesNotExist:
        return Response({"detail": "guest not found"}, status=404)

    meeting = Meeting.objects.create(
        host=request.user,
        guest=guest,
        topic=topic,
        start_datetime=start,
        end_datetime=end,
        status='PENDING',
    )

    Notification.objects.create(
        user=guest,
        actor=request.user,
        type="MEETING_REQUEST",
        data={"meeting_id": meeting.id},
    )

    return Response(MeetingSerializer(meeting).data, status=201)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def respond_meeting(request, meeting_id):
    response = (request.data.get("response") or "").upper()

    try:
        meeting = Meeting.objects.get(id=meeting_id)
    except Meeting.DoesNotExist:
        return Response({"detail": "not found"}, status=404)

    # ✅ Allow both host and guest to respond
    if request.user not in [meeting.host, meeting.guest]:
        return Response({"detail": "forbidden"}, status=403)

    if response == "ACCEPT":
        meeting.status = "ACCEPTED"
        meeting.jitsi_room = (
            f"peerza-{min(meeting.host.id, meeting.guest.id)}-"
            f"{max(meeting.host.id, meeting.guest.id)}-{meeting.id}"
        )
    elif response == "DECLINE":
        meeting.status = "DECLINED"
    else:
        return Response({"detail": "Invalid response"}, status=400)

    meeting.save()

    # Notify the other participant
    other_user = meeting.guest if request.user == meeting.host else meeting.host
    Notification.objects.create(
        user=other_user,
        actor=request.user,
        type="MEETING_RESPONSE",
        data={"meeting_id": meeting.id, "response": meeting.status},
    )

    print(f"✅ Meeting {meeting.id} updated to {meeting.status} by {request.user.username}")

    return Response(MeetingSerializer(meeting).data)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def my_meetings(request):
    qs = Meeting.objects.filter(Q(host=request.user) | Q(guest=request.user))
    return Response(MeetingSerializer(qs, many=True).data)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def pending_meetings(request):
    """
    Pending invites for the logged-in user (receiver/guest).
    Used by dashboard poll.
    """
    meetings = Meeting.objects.filter(
        Q(guest=request.user),
        status='PENDING'
    ).order_by('-created_at')
    return Response(MeetingSerializer(meetings, many=True).data)

# =============================================================
# NOTIFICATIONS
# =============================================================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def notifications_list(request):
    notes = Notification.objects.filter(
        user=request.user, is_read=False
    ).order_by("-created_at")[:50]
    return Response(NotificationSerializer(notes, many=True).data)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def mark_notification_read(request, notification_id):
    try:
        n = Notification.objects.get(id=notification_id, user=request.user)
    except Notification.DoesNotExist:
        return Response({"detail": "Not found"}, status=404)
    n.is_read = True
    n.save()
    return Response({"ok": True})

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def mark_notifications_read_all(request):
    Notification.objects.filter(user=request.user, is_read=False).update(is_read=True)
    return Response({"ok": True})

# =============================================================
# UPDATED CALL START / END (MEETING + NOTIFY)
# =============================================================

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def call_start(request, receiver_id):
    caller = request.user
    receiver = get_object_or_404(User, id=receiver_id)

    if caller == receiver:
        return Response({"error": "You cannot call yourself."}, status=status.HTTP_400_BAD_REQUEST)

    # ✅ Only reuse a PENDING meeting; ignore ACCEPTED/DECLINED/CANCELLED
    meeting = Meeting.objects.filter(
        host=caller,
        guest=receiver,
        status="PENDING",
    ).order_by("-created_at").first()

    if not meeting:
        meeting = Meeting.objects.create(
            host=caller,
            guest=receiver,
            status="PENDING",
            start_datetime=timezone.now(),
        )
        # Notify receiver only when we actually create a new pending request
        Notification.objects.create(
            user=receiver,       # who should receive it
            actor=caller,        # who initiated it
            type="MEETING_REQUEST",
            data={"meeting_id": meeting.id},
        )

    # room name is stable for this pair + this meeting
    room_name = f"Peerza-Class-{caller.id}-{receiver.id}"
    return Response({"ok": True, "room": room_name}, status=status.HTTP_200_OK)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def call_end(request, receiver_id):
    user = request.user
    receiver = get_object_or_404(User, id=receiver_id)
    meeting = Meeting.objects.filter(
        Q(host__in=[user, receiver]),
        Q(guest__in=[user, receiver]),
        status="PENDING",
    ).first()

    if meeting:
        meeting.status = "CANCELLED"
        meeting.end_datetime = timezone.now()
        meeting.save()

    return Response({"ok": True})

# =============================================================
# CHAT
# =============================================================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def chat_conversations(request):
    me = request.user

    msg_peers = set(
        Message.objects.filter(Q(sender=me) | Q(receiver=me)).values_list("sender", flat=True)
    ) | set(
        Message.objects.filter(Q(sender=me) | Q(receiver=me)).values_list("receiver", flat=True)
    )
    msg_peers.discard(me.id)

    friend_ids = set(Friendship.objects.filter(user=me).values_list("friend_id", flat=True))
    peer_ids = msg_peers | friend_ids

    data = []
    for pid in peer_ids:
        peer = User.objects.get(id=pid)
        unread = Message.objects.filter(sender=peer, receiver=me, is_read=False).count()
        last_msg = Message.objects.filter(
            Q(sender=me, receiver=peer) | Q(sender=peer, receiver=me)
        ).order_by('-timestamp').first()
        data.append({
            "peer": UserSerializer(peer).data,
            "unread_count": unread,
            "last_message": MessageSerializer(last_msg).data if last_msg else None,
        })

    data.sort(key=lambda x: x["last_message"]["timestamp"] if x["last_message"] else "", reverse=True)
    return Response(data)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def chat_messages(request, user_id):
    me = request.user
    peer = get_object_or_404(User, id=user_id)
    qs = Message.objects.filter(
        Q(sender=me, receiver=peer) | Q(sender=peer, receiver=me)
    ).order_by('timestamp')
    return Response(MessageSerializer(qs, many=True).data)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def chat_send(request, user_id):
    me = request.user
    peer = get_object_or_404(User, id=user_id)
    text = (request.data.get("content") or "").strip()
    if not text:
        return Response({"detail": "Message content required"}, status=400)
    msg = Message.objects.create(sender=me, receiver=peer, content=text)
    return Response(MessageSerializer(msg).data, status=201)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def chat_mark_read(request, user_id):
    me = request.user
    peer = get_object_or_404(User, id=user_id)
    Message.objects.filter(sender=peer, receiver=me, is_read=False).update(is_read=True)
    return Response({"ok": True})

# =============================================================
# FRIENDS
# =============================================================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def friends_list(request):
    me = request.user
    qs = Friendship.objects.filter(user=me).select_related("friend")
    data = [{"id": f.id, "friend": UserSerializer(f.friend).data} for f in qs]
    return Response(data)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def friend_request_send(request, user_id):
    me = request.user
    to_user = get_object_or_404(User, id=user_id)
    if to_user == me:
        return Response({"detail": "cannot friend yourself"}, status=400)

    fr, created = FriendRequest.objects.get_or_create(from_user=me, to_user=to_user)
    if not created and fr.status != FriendRequest.PENDING:
        fr.status = FriendRequest.PENDING
        fr.save()

    Notification.objects.create(
        user=to_user, actor=me, type="FRIEND_REQUEST", data={"request_id": fr.id}
    )
    return Response({"ok": True, "request_id": fr.id}, status=201)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def friend_request_respond(request, request_id):
    me = request.user
    action = (request.data.get("action") or "").upper()
    fr = get_object_or_404(FriendRequest, id=request_id, to_user=me)

    if action == "ACCEPT":
        fr.status = FriendRequest.ACCEPTED
        fr.save()
        Friendship.objects.get_or_create(user=me, friend=fr.from_user)
        Friendship.objects.get_or_create(user=fr.from_user, friend=me)
        Notification.objects.create(user=fr.from_user, actor=me, type="FRIEND_ACCEPTED", data={})
    elif action == "DECLINE":
        fr.status = FriendRequest.DECLINED
        fr.save()
        Notification.objects.create(user=fr.from_user, actor=me, type="FRIEND_DECLINED", data={})
    else:
        return Response({"detail": "Invalid action"}, status=400)

    return Response({"ok": True})

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def friend_requests_inbox(request):
    me = request.user
    qs = FriendRequest.objects.filter(
        to_user=me, status=FriendRequest.PENDING
    ).select_related("from_user")
    return Response(FriendRequestSerializer(qs, many=True).data)

# =========================================================
# AVAILABILITY (Scheduler)
# =========================================================
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from .models import Availability
from .serializers import AvailabilitySerializer

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_user_availability(request, user_id):
    slots = Availability.objects.filter(user_id=user_id)
    return Response(AvailabilitySerializer(slots, many=True).data)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def create_or_update_availability(request):
    serializer = AvailabilitySerializer(data=request.data, many=True)
    if serializer.is_valid():
        Availability.objects.filter(user=request.user).delete()
        for slot in serializer.validated_data:
            Availability.objects.create(user=request.user, **slot)
        return Response({"message": "Availability updated!"}, status=201)
    return Response(serializer.errors, status=400)



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\views_meeting.py
========================================
from rest_framework import viewsets, permissions
from .models import Meeting
from .serializers import MeetingSerializer

class MeetingViewSet(viewsets.ModelViewSet):
    queryset = Meeting.objects.all().order_by('-start_datetime')
    serializer_class = MeetingSerializer
    permission_classes = [permissions.IsAuthenticated]

    def perform_create(self, serializer):
        serializer.save(host=self.request.user)



========================================
FILE: C:\D Drive Files\BSIT-B-F23\5th Semester\Advanced Web (Python Based)\Semester Project\Peerza_project\peerza_backend\users\__init__.py
========================================



